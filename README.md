# Typescript AWS Template

## Strucure

```lambda-layer/
    ├── src/
    │   ├── models/
    │   ├── services/
    │   ├── config.ts                # Central configuration
    │   └── index.ts                 # Re-exports models, services, and config
    ├── dist/                        # Compiled JavaScript files (generated by build)
    ├── nodejs/                      # Directory needed by AWS Lambda Layers
    ├── package.json                 # Define project dependencies (e.g., aws-sdk)
    └── tsconfig.json                # TypeScript configuration
```

## General Notes

* Every Deployment of the later will increase the version, there's no way to update individual specific versions
* The layer much be attached to the lambda each deployment to keep the version up to date (unless intentionally using lower version)
* Lambda code itself must be redeployed to pick up new layer version attached

## Simple Run/Deploy Instructions through CLI

* Run these in root (don't cd src/)
* nodejs/ must contain node_modules, when you install dependencies it will also populate the dist/ and node_modules/ folders outside of src
* For deployment using SSO, run: ```export AWS_PROFILE=dev``` if needed; remember if the login credentials don't refresh to do also: ```aws sso login --profile dev```

1- ```yarn build```

2- ```yarn package```

3 - ```yarn deploy```

## CLI Commands

### Create Layer

``` aws lambda publish-layer-version \
  --layer-name <LAYER_NAME> \
  --zip-file fileb://layer.zip \
  --compatible-runtimes nodejs20.x \
  --region us-west-2
```

### Attach Layer to Lambda Function

* Anytime there is a new deployment of the layer the version is increased, run the following to update the version your lambda is using:

``` aws lambda update-function-configuration \
  --function-name <MyLambdaFunction> \
  --layers arn:aws:lambda:us-west-2:961171757719:layer:<LAYER_NAME>:<VERSION>
```

## Addition to Lambdas 
* For any lambda that is importing libs/services from this lambda layer, you need to disclude mpc-common from the build 
* In the package.json of the lambda add ```--external:mpc-common```
* For example, in scripts the build command should be:
``` "build": "esbuild index.ts --bundle --minify --sourcemap --platform=node --target=es2020 --outfile=dist/index.js --external:mpc-common", ``` 


## AWS Docs Reference

<https://docs.aws.amazon.com/lambda/latest/dg/chapter-layers.html>

<https://docs.aws.amazon.com/serverlessrepo/latest/devguide/sharing-lambda-layers.html>
